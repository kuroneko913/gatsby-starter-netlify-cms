---
title: XMの取引結果を毎日自動でFreeeに連携するしくみを作る！　その2 XMの取引履歴をメールから取得する。
date: 2021-03-13T04:26:23.148Z
description: GASを使ってメールをパースし、
  メール本文中のテーブルをCSVとして出力することをやってみました。最後に、AWSのS3のバケットにCSVファイルを送るのもやってます。
---
## はじめに

この記事は[前回のつづき](https://myblackcat913.com/2021-03-13-xm%E3%81%AE%E5%8F%96%E5%BC%95%E7%B5%90%E6%9E%9C%E3%82%92%E6%AF%8E%E6%97%A5%E8%87%AA%E5%8B%95%E3%81%A7freee%E3%81%AB%E9%80%A3%E6%90%BA%E3%81%99%E3%82%8B%E3%81%97%E3%81%8F%E3%81%BF%E3%82%92%E4%BD%9C%E3%82%8B%EF%BC%81%E3%80%80%E3%81%9D%E3%81%AE%EF%BC%91%E3%81%BE%E3%81%9A%E5%95%8F%E9%A1%8C%E3%82%92%E5%88%86%E8%A7%A3%E3%81%97%E3%81%A6%E8%80%83%E3%81%88%E3%82%8B%E3%80%82/)
であり、海外FX業者XMでの取引履歴を自動的に会計Freeeに反映するための仕組みを考えるものである。
今回は、前回分解したタスクの１つである、「XMの取引履歴の自動取得」を実現するための方法を考える。

## XMの取引履歴

海外FX取引業者のXMは、1日の取引が終了した後(日本時間の午前6時ごろ)にその日1日の取引結果、取引中のポジションなどをメールで通知してくれる。このメールは、htmlで書かれた表形式でいつどのような取引が行われたか、その結果どの程度損益が発生したかが記載されている。したがって、既に取引が成立(買った株や為替を売却、もしくは空売した為替を買い戻した状態)の結果をGASでメール記載の表から読み取り、各取引ごとにCSVに書き出せばとりあえず、取引履歴を取り扱いしやすい状態にできる。

![メールにある取引履歴の例](/images/uploaded/20210516-225645.png)

![HTMLで表が記載されている](/images/uploaded/20210516-225953.png)

## Gmailをパースする
今回はメール本文のテーブル構造を読み取りCSVファイルに書き起こすため、Parserを使用した。

Parserの導入、詳しい使用方法は[ここ](https://specially198.com/scraping-with-gas-using-parser-library/)を参考にすればいいと思う。


```
let parsed_html = Parser.data(mail_text.body).from('<tr align=right>').to('</tr>').iterate()
```


## GASでCSVを書き出す

## GASからS3にファイルを送る